<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edge Feathering Test - Visual Comparison</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #121212;
      --surface: #1e1e1e;
      --primary: #4ade80;
      --text: #e0e0e0;
      --muted: #888;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: var(--primary);
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: var(--muted);
      margin-bottom: 30px;
    }
    
    .test-controls {
      background: var(--surface);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    
    .control-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
    }
    
    label {
      min-width: 120px;
    }
    
    input[type="range"] {
      flex: 1;
      max-width: 300px;
    }
    
    input[type="file"] {
      padding: 10px;
      background: var(--bg);
      border: 1px dashed var(--muted);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
    }
    
    .value-display {
      color: var(--primary);
      font-weight: 600;
      min-width: 50px;
    }
    
    button {
      background: var(--primary);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    button:hover {
      transform: translateY(-2px);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }
    
    .comparison-item {
      background: var(--surface);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .comparison-header {
      padding: 15px;
      border-bottom: 1px solid #333;
    }
    
    .comparison-header h3 {
      color: var(--primary);
      font-size: 1rem;
    }
    
    .comparison-header p {
      color: var(--muted);
      font-size: 0.875rem;
    }
    
    .comparison-canvas {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .status {
      padding: 15px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 20px;
      font-family: monospace;
      font-size: 0.875rem;
    }
    
    .status.loading {
      border-left: 3px solid #f59e0b;
    }
    
    .status.success {
      border-left: 3px solid var(--primary);
    }
    
    .status.error {
      border-left: 3px solid #ef4444;
    }
    
    .info-box {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid var(--primary);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .info-box h4 {
      color: var(--primary);
      margin-bottom: 8px;
    }
    
    .info-box ul {
      margin-left: 20px;
      color: var(--muted);
    }
    
    .info-box li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”¬ Edge Feathering Visual Test</h1>
    <p class="subtitle">Compare watermark removal with different feather values to validate quality improvements</p>
    
    <div class="info-box">
      <h4>How to Test</h4>
      <ul>
        <li>Select an image with a Gemini watermark in the bottom-right corner</li>
        <li>Use the feather slider to adjust edge blend amount (0 = hard edge, 50 = very smooth)</li>
        <li>Click "Process" to run the AI watermark removal</li>
        <li>Compare results with different feather values - look for visible edges at the blend boundary</li>
      </ul>
    </div>
    
    <div class="test-controls">
      <div class="control-row">
        <label>Test Image:</label>
        <input type="file" id="imageInput" accept="image/*">
      </div>
      
      <div class="control-row">
        <label>Feather Size:</label>
        <input type="range" id="featherSlider" min="0" max="50" value="20">
        <span class="value-display" id="featherDisplay">20px</span>
      </div>
      
      <div class="control-row">
        <button id="processBtn" disabled>Process Image</button>
        <button id="compareBtn" disabled style="background: #333; color: var(--text);">Add Comparison (Feather: 0)</button>
      </div>
    </div>
    
    <div class="status" id="status">Ready - Select an image to begin</div>
    
    <div class="comparison-grid" id="comparisonGrid">
      <!-- Results will be added here -->
    </div>
  </div>

  <!-- ONNX Runtime -->
  <script src="src/lib/ort.min.js"></script>
  
  <script type="module">
    import { CONFIG } from './src/js/config.js';
    import { loadImageFromFile } from './src/js/utils.js';
    import { modelManager } from './src/js/model-manager.js';
    import { preprocessImage, postprocessImage, composeFinalImage, resizeImageForModel } from './src/js/image-processor.js';

    let currentImage = null;
    let modelReady = false;
    let comparisonCount = 0;

    const imageInput = document.getElementById('imageInput');
    const featherSlider = document.getElementById('featherSlider');
    const featherDisplay = document.getElementById('featherDisplay');
    const processBtn = document.getElementById('processBtn');
    const compareBtn = document.getElementById('compareBtn');
    const statusEl = document.getElementById('status');
    const gridEl = document.getElementById('comparisonGrid');

    // Update feather display
    featherSlider.addEventListener('input', (e) => {
      featherDisplay.textContent = `${e.target.value}px`;
    });

    // Image selection
    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        setStatus('Loading image...', 'loading');
        currentImage = { file, bitmap: await loadImageFromFile(file) };
        setStatus(`Image loaded: ${currentImage.bitmap.width}x${currentImage.bitmap.height}px`, 'success');
        processBtn.disabled = false;
        compareBtn.disabled = false;
      } catch (err) {
        setStatus(`Error: ${err.message}`, 'error');
      }
    });

    // Process with current feather value
    processBtn.addEventListener('click', async () => {
      if (!currentImage) return;
      await processImage(parseInt(featherSlider.value, 10));
    });

    // Process with feather=0 for comparison
    compareBtn.addEventListener('click', async () => {
      if (!currentImage) return;
      await processImage(0);
    });

    async function processImage(featherSize) {
      try {
        processBtn.disabled = true;
        compareBtn.disabled = true;
        
        // Initialize model if needed
        if (!modelReady) {
          setStatus('Loading AI model... (first time only)', 'loading');
          await modelManager.initialize((percent) => {
            setStatus(`Loading AI model... ${percent}%`, 'loading');
          });
          modelReady = true;
        }
        
        setStatus(`Processing with feather=${featherSize}px...`, 'loading');
        const startTime = performance.now();
        
        // Process image
        const resizedImageData = resizeImageForModel(currentImage.bitmap);
        const { imageTensor, maskTensor } = preprocessImage(resizedImageData);
        const outputTensor = await modelManager.runInference({ image: imageTensor, mask: maskTensor });
        const processedImageData = postprocessImage(outputTensor, CONFIG.MODEL.INPUT_SIZE, CONFIG.MODEL.INPUT_SIZE);
        const finalDataUrl = composeFinalImage(currentImage.bitmap, processedImageData, featherSize);
        
        const elapsed = Math.round(performance.now() - startTime);
        setStatus(`Done! Processed in ${elapsed}ms with feather=${featherSize}px`, 'success');
        
        // Add to comparison grid
        addComparison(featherSize, finalDataUrl, elapsed);
        
      } catch (err) {
        setStatus(`Error: ${err.message}`, 'error');
      } finally {
        processBtn.disabled = false;
        compareBtn.disabled = false;
      }
    }

    function addComparison(featherSize, dataUrl, elapsed) {
      comparisonCount++;
      const item = document.createElement('div');
      item.className = 'comparison-item';
      item.innerHTML = `
        <div class="comparison-header">
          <h3>Result #${comparisonCount} - Feather: ${featherSize}px</h3>
          <p>Processed in ${elapsed}ms | ${currentImage.bitmap.width}x${currentImage.bitmap.height}px</p>
        </div>
        <img class="comparison-canvas" src="${dataUrl}" alt="Result with feather ${featherSize}px">
      `;
      gridEl.prepend(item);
    }

    function setStatus(msg, type = '') {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + type;
    }
  </script>
</body>
</html>
